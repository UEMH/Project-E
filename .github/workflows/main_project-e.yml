# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - Project-E

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present        
    
      - name: Create necessary directories
        run: |
          mkdir -p public/css
          mkdir -p public/images/wallpapers
          mkdir -p scripts
          
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: .
          retention-days: 1

      - name: Run database migration (if needed)
        run: |
          # åˆ›å»ºè¿ç§»è„šæœ¬æ–‡ä»¶
          cat > scripts/migrate.js << 'EOF'
          const mongoose = require('mongoose');
          const User = require('./models/User');
          const UserSettings = require('./models/UserSettings');
          const Bookmark = require('./models/Bookmark');
          
          const migrateDatabase = async () => {
            try {
              console.log('ğŸš€ å¼€å§‹æ•°æ®åº“è¿ç§»...');
              await mongoose.connect(process.env.MONGODB_URI);
              console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
              
              const users = await User.find({});
              console.log(`ğŸ“‹ æ‰¾åˆ° ${users.length} ä¸ªç”¨æˆ·`);
              
              for (const user of users) {
                const existingSettings = await UserSettings.findOne({ userId: user._id });
                if (!existingSettings) {
                  await UserSettings.getOrCreateSettings(user._id);
                  console.log(`âœ… ä¸ºç”¨æˆ· ${user.username} åˆ›å»ºè®¾ç½®`);
                }
              }
              
              console.log('ğŸ‰ æ•°æ®åº“è¿ç§»å®Œæˆ');
            } catch (error) {
              console.error('âŒ æ•°æ®åº“è¿ç§»å¤±è´¥:', error);
            } finally {
              await mongoose.disconnect();
            }
          };
          
          migrateDatabase();
          EOF

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_67F8F2690F604033B4F590FF6E556B81 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_F1860E5E07554494A1C540B166053767 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_8F243862EEB64A68AE6BF3D4ACE42544 }}

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Project-E'
          slot-name: 'Production'
          package: .





