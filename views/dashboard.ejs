<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEMH_HP</title>
    <link rel="icon" type="image/x-icon" href="/images/cat.ico">
    <style>
        /* æ‰€æœ‰åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
        /* åªæ·»åŠ ç¦»çº¿çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ç¦»çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
        }
        
        /* ç”¨æˆ·ä¿¡æ¯æ  */
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ä¹¦ç­¾æ æ ·å¼ */
        .top-bookmarks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 999;
            padding: 10px 0;
            transition: all 0.3s ease;
        }
        
        .top-bookmarks.collapsed {
            transform: translateY(-100%);
        }
        
        .bookmarks-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .bookmarks-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .bookmark-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
        }
        
        .bookmark-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .icon-container {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }
        
        .bookmark-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .emoji-icon {
            font-size: 16px;
        }
        
        .bookmarks-header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed !important;
        }
        
        .disabled-btn:hover {
            transform: none !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }
        
        /* èƒŒæ™¯å’Œå†…å®¹åŒºåŸŸ */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            background-size: cover;
            background-position: center;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .content {
            padding: 120px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .content h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .content p {
            font-size: 1.2rem;
            max-width: 600px;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            color: #333;
        }
        
        .modal h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            flex: 1;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    
    </style>
</head>
<body>
    <!-- ç¦»çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <% if (!dbConnected) { %>
        <div class="offline-indicator">
            âš ï¸ ç¦»çº¿æ¨¡å¼
        </div>
    <% } %>

    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div class="user-info">
        <% if (user) { %>
            <span>æ¬¢è¿, <%= user.username %></span>
            <% if (user.id === 'offline-admin') { %>
                <span style="color: #ffa500; margin-left: 5px;">(ç¦»çº¿)</span>
            <% } %>
            <form action="/logout" method="POST" style="display: inline;">
                <button type="submit" class="auth-btn">ç™»å‡º</button>
            </form>
        <% } else { %>
            <a href="/login" class="auth-btn">ç™»å½•</a>
        <% } %>
    </div>

    <!-- å›ºå®šåœ¨é¡¶éƒ¨çš„ä¹¦ç­¾æ  -->
    <div class="top-bookmarks" id="topBookmarks">
        <div class="bookmarks-container">
            <div class="bookmarks-bar" id="bookmarksBar">
                <!-- ä¹¦ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="bookmarks-header-buttons">
                <button class="header-btn" id="importBookmarks" title="å¯¼å…¥æ”¶è—å¤¹">ğŸš©</button>
                <button class="header-btn <%= !user && 'disabled-btn' %>" id="changeWallpaper" title="æ›´æ”¹å£çº¸" <%= !user && 'disabled' %>>ğŸ–¼ï¸</button>
                <button class="header-btn" id="helpBtn" title="ä½¿ç”¨è¯´æ˜">â“</button>
                <button class="header-btn" id="collapseBtn" title="æ”¶èµ·æ”¶è—å¤¾">â–²</button>
            </div>
        </div>
    </div>

    <!-- æ”¶è—å¤¹æ”¶èµ·æ—¶çš„å±•å¼€æŒ‰é’® -->
    <button class="expand-bookmarks" id="expandBookmarks" title="å±•é–‹æ”¶è—å¤¾">â–¼</button>

    <!-- èƒŒæ™¯å®¹å™¨ - ä½¿ç”¨CSSæ¸å˜èƒŒæ™¯ -->
    <div class="background-container">
        <div class="bg-image" id="bgImage"></div>
    </div>
    
    <div class="content" id="content">
        <h1>æ¬¢è¿ä½¿ç”¨ UEMH_HP</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªç®€æ´ç¾è§‚çš„æµè§ˆå™¨èµ·å§‹é¡µï¼Œæ”¶è—å¤¹å›ºå®šåœ¨é¡¶éƒ¨æ–¹ä¾¿è®¿é—®ã€‚å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸå¯ä»¥æ·»åŠ æ–°æ”¶è—é¡¹ã€‚</p>
    </div>
    
    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="addBookmark">æ·»åŠ æ–°æ”¶è—</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="editBookmark">ç¼–è¾‘æ”¶è—</div>
        <div class="context-menu-item" id="deleteBookmark">åˆ é™¤æ”¶è—</div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘æ”¶è—é¡¹çš„æ¨¡æ€æ¡† -->
    <div class="modal" id="bookmarkModal">
        <div class="modal-content">
            <h2 id="modalTitle">æ·»åŠ æ”¶è—</h2>
            <div class="form-group">
                <label for="bookmarkName">åç§° (å¯é€‰)</label>
                <input type="text" id="bookmarkName" placeholder="è¾“å…¥æ”¶è—åç§° (ç•™ç©ºåˆ™ä»…æ˜¾ç¤ºå›¾æ ‡)">
            </div>
            <div class="form-group">
                <label for="bookmarkUrl">ç½‘å€</label>
                <input type="text" id="bookmarkUrl" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label for="bookmarkIcon">å›¾æ ‡ (å¯é€‰ - è¾“å…¥å›¾ç‰‡URLæˆ–è¡¨æƒ…ç¬¦å·)</label>
                <input type="text" id="bookmarkIcon" placeholder="è¾“å…¥å›¾ç‰‡URLæˆ–è¡¨æƒ…ç¬¦å·">
                <div class="icon-preview" id="iconPreview"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBookmark">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveBookmark">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ›´æ”¹å£çº¸æ¨¡æ€æ¡† -->
    <div class="modal" id="wallpaperModal">
        <div class="modal-content">
            <h2>æ›´æ”¹å£çº¸</h2>
            <div class="form-group">
                <label for="wallpaperFile">é€‰æ‹©å£çº¸å›¾ç‰‡</label>
                <input type="file" id="wallpaperFile" accept="image/*">
                <div class="wallpaper-preview" id="wallpaperPreview">
                    <img id="wallpaperPreviewImg" src="" alt="å£çº¸é¢„è§ˆ">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelWallpaper">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveWallpaper">ç¡®å®šæ›´æ¢</button>
            </div>
        </div>
    </div>

    <!-- å¸®åŠ©è¯´æ˜æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="help-content">
                <h2>æ­¡è¿ä½¿ç”¨ä¸»é </h2>
                <p>é€™æ˜¯ä¸€å€‹ç°¡æ½”ç¾è§€çš„ç€è¦½å™¨èµ·å§‹é ï¼Œæ”¶è—å¤¾å›ºå®šåœ¨é ‚éƒ¨æ–¹ä¾¿è¨ªå•</p>
                
                <h3>ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>å·¦é”®ç‚¹å‡» - è®¿é—®ç½‘ç«™</li>
                    <li>å·¦é”®æ‹–æ‹½ - é‡æ–°æ’åºæ”¶è—é¡¹</li>
                    <li>å³é”®ç‚¹å‡»æ”¶è—é¡¹ - ç¼–è¾‘æˆ–åˆ é™¤</li>
                    <li>å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸ - æ·»åŠ æ–°æ”¶è—é¡¹</li>
                    <li>æ‰€æœ‰æ›´æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</li>
                    <li>æ”¶è—é¡¹å¯ä»¥ä»…æ˜¾ç¤ºå›¾æ ‡ï¼Œæ— éœ€åç§°</li>
                    <li>æ·»åŠ ä¹¦ç­¾æ—¶å¦‚æœä¸æä¾›å›¾æ ‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•è·å–ç½‘ç«™å›¾æ ‡</li>
                    <% if (user) { %>
                        <li>å½“å‰ç”¨æˆ·: <strong><%= user.username %></strong></li>
                    <% } else { %>
                        <li><a href="/login" style="color: #4FC3F7;">ç‚¹å‡»ç™»å½•</a>ä»¥ä½¿ç”¨æ›´æ”¹å£çº¸åŠŸèƒ½</li>
                    <% } %>
                    <% if (!dbConnected) { %>
                        <li style="color: #ffa500;">âš ï¸ å½“å‰è¿è¡Œåœ¨ç¦»çº¿æ¨¡å¼</li>
                    <% } %>
                </ul>
                
                <h3>é»˜è®¤è´¦å·</h3>
                <p>ç”¨æˆ·å: <strong>UEMH-CHAN</strong><br>å¯†ç : <strong>041018</strong></p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeHelp">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯å®¹å™¨ -->
    <div class="debug-container" id="debugContainer">
        <div class="debug-header" id="debugHeader">
            <div class="debug-title">è°ƒè¯•ä¿¡æ¯</div>
            <div class="debug-controls">
                <button class="debug-toggle" id="debugToggle">âˆ’</button>
                <button class="debug-toggle" id="debugHide">Ã—</button>
            </div>
        </div>
        <div class="debug-info" id="debugInfo"></div>
        <div class="debug-slider-container">
            <span>é€æ˜åº¦:</span>
            <input type="range" min="0" max="100" value="70" class="debug-slider" id="debugOpacity">
        </div>
    </div>

    <script>
        // åˆå§‹æ”¶è—é¡¹æ•°æ®
        const defaultBookmarks = [
            { id: 1, name: "Google", url: "https://www.google.com", icon: "https://www.google.com/favicon.ico" },
            { id: 2, name: "YouTube", url: "https://www.youtube.com", icon: "https://www.youtube.com/favicon.ico" },
            { id: 3, name: "GitHub", url: "https://github.com", icon: "https://github.com/favicon.ico" },
            { id: 4, name: "", url: "https://homdgcat.wiki/sr/char?lang=CH", icon: "https://favicon.is/homdgcat.wiki" },
            { id: 5, name: "è¡¨æƒ…ç¬¦å·", url: "https://example.com", icon: "ğŸ”" }
        ];

        // DOMå…ƒç´ 
        let topBookmarks, bookmarksBar, contextMenu, bookmarkModal, helpModal, wallpaperModal;
        let modalTitle, bookmarkName, bookmarkUrl, bookmarkIcon, iconPreview;
        let saveBookmarkBtn, cancelBookmarkBtn, addBookmarkBtn, editBookmarkBtn, deleteBookmarkBtn;
        let importBookmarksBtn, helpBtn, collapseBtn, expandBookmarks, content, closeHelp;
        let changeWallpaperBtn, wallpaperFile, wallpaperPreview, cancelWallpaperBtn, saveWallpaperBtn;
        let debugContainer, debugInfo, debugToggle, debugHide, debugOpacity, debugHeader;

        // å…¨å±€å˜é‡
        let bookmarks = [];
        let currentBookmarkId = null;
        let isEditing = false;
        let isDebugCollapsed = false;
        let isDebugHidden = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            debug('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            
            // åˆå§‹åŒ–DOMå…ƒç´ 
            initDOMElements();
            
            // åŠ è½½æ”¶è—é¡¹
            loadBookmarks();
            renderBookmarks();
            setupEventListeners();
            loadCollapseState();
            setupDebugControls();
            
            debug('åˆå§‹åŒ–å®Œæˆ');
        });

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initDOMElements() {
            debug('åˆå§‹åŒ–DOMå…ƒç´ ');
            
            topBookmarks = document.getElementById('topBookmarks');
            bookmarksBar = document.getElementById('bookmarksBar');
            contextMenu = document.getElementById('contextMenu');
            bookmarkModal = document.getElementById('bookmarkModal');
            helpModal = document.getElementById('helpModal');
            wallpaperModal = document.getElementById('wallpaperModal');
            
            modalTitle = document.getElementById('modalTitle');
            bookmarkName = document.getElementById('bookmarkName');
            bookmarkUrl = document.getElementById('bookmarkUrl');
            bookmarkIcon = document.getElementById('bookmarkIcon');
            iconPreview = document.getElementById('iconPreview');
            saveBookmarkBtn = document.getElementById('saveBookmark');
            cancelBookmarkBtn = document.getElementById('cancelBookmark');
            addBookmarkBtn = document.getElementById('addBookmark');
            editBookmarkBtn = document.getElementById('editBookmark');
            deleteBookmarkBtn = document.getElementById('deleteBookmark');
            importBookmarksBtn = document.getElementById('importBookmarks');
            helpBtn = document.getElementById('helpBtn');
            collapseBtn = document.getElementById('collapseBtn');
            expandBookmarks = document.getElementById('expandBookmarks');
            content = document.getElementById('content');
            closeHelp = document.getElementById('closeHelp');
            
            // å£çº¸ç›¸å…³å…ƒç´ 
            changeWallpaperBtn = document.getElementById('changeWallpaper');
            wallpaperFile = document.getElementById('wallpaperFile');
            wallpaperPreview = document.getElementById('wallpaperPreview');
            cancelWallpaperBtn = document.getElementById('cancelWallpaper');
            saveWallpaperBtn = document.getElementById('saveWallpaper');
            
            // è°ƒè¯•ç›¸å…³å…ƒç´ 
            debugContainer = document.getElementById('debugContainer');
            debugInfo = document.getElementById('debugInfo');
            debugToggle = document.getElementById('debugToggle');
            debugHide = document.getElementById('debugHide');
            debugOpacity = document.getElementById('debugOpacity');
            debugHeader = document.getElementById('debugHeader');
            
            debug('DOMå…ƒç´ åˆå§‹åŒ–å®Œæˆ');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            debug('å¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
            
            // å³é”®èœå•é€‰é¡¹
            addBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                showBookmarkModal();
                debug('ç‚¹å‡»æ·»åŠ æ”¶è—é¡¹æŒ‰é’®');
            });
            
            editBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                showBookmarkModal(true);
                debug('ç‚¹å‡»ç¼–è¾‘æ”¶è—é¡¹æŒ‰é’®');
            });
            
            deleteBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                deleteBookmark();
                debug('ç‚¹å‡»åˆ é™¤æ”¶è—é¡¹æŒ‰é’®');
            });
            
            // æ¨¡æ€æ¡†æŒ‰é’®
            saveBookmarkBtn.addEventListener('click', saveBookmark);
            debug('ä¿å­˜æ”¶è—é¡¹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            cancelBookmarkBtn.addEventListener('click', () => {
                bookmarkModal.style.display = 'none';
                debug('ç‚¹å‡»å–æ¶ˆæŒ‰é’®');
            });
            
            // å›¾æ ‡é¢„è§ˆ
            bookmarkIcon.addEventListener('input', updateIconPreview);
            debug('å›¾æ ‡é¢„è§ˆäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            // å¯¼å…¥åŠŸèƒ½
            importBookmarksBtn.addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.html';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        parseBookmarksHTML(content);
                    };
                    reader.readAsText(file);
                    debug('é€‰æ‹©æ–‡ä»¶: ' + file.name);
                };
                fileInput.click();
            });
            
            // å£çº¸åŠŸèƒ½
            changeWallpaperBtn.addEventListener('click', showWallpaperModal);
            cancelWallpaperBtn.addEventListener('click', hideWallpaperModal);
            saveWallpaperBtn.addEventListener('click', uploadWallpaper);
            wallpaperFile.addEventListener('change', previewWallpaper);
            
            // å¸®åŠ©æŒ‰é’®
            helpBtn.addEventListener('click', () => {
                helpModal.style.display = 'flex';
                debug('ç‚¹å‡»å¸®åŠ©æŒ‰é’®');
            });
            
            closeHelp.addEventListener('click', () => {
                helpModal.style.display = 'none';
                debug('ç‚¹å‡»å…³é—­å¸®åŠ©æŒ‰é’®');
            });
            
            // æ”¶èµ·/å±•å¼€åŠŸèƒ½
            collapseBtn.addEventListener('click', collapseBookmarks);
            expandBookmarks.addEventListener('click', expandBookmarksFunc);
            debug('æ”¶èµ·/å±•å¼€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            debug('æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        // æ˜¾ç¤ºå£çº¸æ¨¡æ€æ¡†
        function showWallpaperModal() {
            <% if (!user) { %>
                alert('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨å£çº¸æ›´æ”¹åŠŸèƒ½');
                return;
            <% } %>
            wallpaperModal.style.display = 'flex';
            wallpaperFile.value = '';
            wallpaperPreview.style.display = 'none';
            debug('æ˜¾ç¤ºæ›´æ”¹å£çº¸æ¨¡æ€æ¡†');
        }

        // éšè—å£çº¸æ¨¡æ€æ¡†
        function hideWallpaperModal() {
            wallpaperModal.style.display = 'none';
            debug('éšè—æ›´æ”¹å£çº¸æ¨¡æ€æ¡†');
        }

        // é¢„è§ˆå£çº¸
        function previewWallpaper(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewImg = document.getElementById('wallpaperPreviewImg');
                    previewImg.src = e.target.result;
                    wallpaperPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                debug('å£çº¸é¢„è§ˆå·²æ›´æ–°');
            }
        }

        // ä¸Šä¼ å£çº¸
        function uploadWallpaper() {
            const file = wallpaperFile.files[0];
            if (!file) {
                alert('è¯·é€‰æ‹©å£çº¸å›¾ç‰‡');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // ä¿å­˜å£çº¸åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('customWallpaper', e.target.result);
                
                // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
                document.getElementById('bgImage').style.backgroundImage = `url('${e.target.result}')`;
                
                alert('å£çº¸æ›´æ¢æˆåŠŸï¼');
                hideWallpaperModal();
                debug('å£çº¸æ›´æ¢æˆåŠŸ');
            };
            reader.readAsDataURL(file);
        }

        // åŠ è½½æ”¶è—é¡¹
        function loadBookmarks() {
            const savedBookmarks = localStorage.getItem('customBookmarks');
            if (savedBookmarks) {
                bookmarks = JSON.parse(savedBookmarks);
                debug('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ”¶è—é¡¹: ' + bookmarks.length + ' é¡¹');
            } else {
                bookmarks = [...defaultBookmarks];
                saveBookmarks();
                debug('ä½¿ç”¨é»˜è®¤æ”¶è—é¡¹');
            }
            
            // åŠ è½½è‡ªå®šä¹‰å£çº¸
            const customWallpaper = localStorage.getItem('customWallpaper');
            if (customWallpaper) {
                document.getElementById('bgImage').style.backgroundImage = `url('${customWallpaper}')`;
                debug('åŠ è½½è‡ªå®šä¹‰å£çº¸');
            }
        }

        // ä¿å­˜æ”¶è—é¡¹åˆ°æœ¬åœ°å­˜å‚¨
        function saveBookmarks() {
            localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
            debug('ä¿å­˜æ”¶è—é¡¹åˆ°æœ¬åœ°å­˜å‚¨: ' + bookmarks.length + ' é¡¹');
        }

        // æ¸²æŸ“æ”¶è—é¡¹
        function renderBookmarks() {
            bookmarksBar.innerHTML = '';
            
            bookmarks.forEach(bookmark => {
                const bookmarkElement = document.createElement('div');
                bookmarkElement.className = 'bookmark-item';
                bookmarkElement.setAttribute('data-id', bookmark.id);
                bookmarkElement.draggable = true;
                
                let iconHTML = '';
                if (bookmark.icon) {
                    if (bookmark.icon.startsWith('http')) {
                        iconHTML = `
                            <div class="icon-container">
                                <img src="${bookmark.icon}" class="bookmark-icon" alt="${bookmark.name}" onerror="handleIconError(this)">
                            </div>
                        `;
                    } else {
                        iconHTML = `
                            <div class="icon-container">
                                <span class="emoji-icon">${bookmark.icon}</span>
                            </div>
                        `;
                    }
                } else {
                    iconHTML = `
                        <div class="icon-container">
                            <span class="emoji-icon">ğŸ”—</span>
                        </div>
                    `;
                }
                
                if (!bookmark.name || bookmark.name.trim() === '') {
                    bookmarkElement.innerHTML = `
                        <a href="${bookmark.url}" target="_blank" title="${bookmark.url}">${iconHTML}</a>
                    `;
                } else {
                    bookmarkElement.innerHTML = `
                        ${iconHTML}
                        <a href="${bookmark.url}" target="_blank">${bookmark.name}</a>
                    `;
                }
                
                bookmarksBar.appendChild(bookmarkElement);
            });
            
            setupBookmarkEvents();
            debug('æ¸²æŸ“æ”¶è—é¡¹å®Œæˆ: ' + bookmarks.length + ' é¡¹');
        }

        // å¤„ç†å›¾æ ‡åŠ è½½é”™è¯¯
        function handleIconError(imgElement) {
            const container = imgElement.parentNode;
            container.innerHTML = '<span class="emoji-icon">âŒ</span>';
            debug('å›¾æ ‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å›¾æ ‡');
        }

        // è®¾ç½®æ”¶è—é¡¹äº‹ä»¶ç›‘å¬
        function setupBookmarkEvents() {
            const bookmarkItems = document.querySelectorAll('.bookmark-item');
            
            bookmarkItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const id = parseInt(item.getAttribute('data-id'));
                    const bookmark = bookmarks.find(b => b.id === id);
                    if (bookmark) {
                        window.open(bookmark.url, '_blank');
                        debug('æ‰“å¼€é“¾æ¥: ' + bookmark.url);
                    }
                });
                
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    currentBookmarkId = parseInt(item.getAttribute('data-id'));
                    
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    
                    addBookmarkBtn.style.display = 'none';
                    editBookmarkBtn.style.display = 'block';
                    deleteBookmarkBtn.style.display = 'block';
                    
                    debug('æ˜¾ç¤ºå³é”®èœå• - ç¼–è¾‘æ”¶è—é¡¹ ID: ' + currentBookmarkId);
                });
                
                // æ‹–æ‹½äº‹ä»¶
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.getAttribute('data-id'));
                    debug('å¼€å§‹æ‹–æ‹½æ”¶è—é¡¹ ID: ' + item.getAttribute('data-id'));
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    debug('ç»“æŸæ‹–æ‹½æ”¶è—é¡¹');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = parseInt(item.getAttribute('data-id'));
                    
                    if (draggedId !== targetId) {
                        moveBookmark(draggedId, targetId);
                    }
                });
            });
            
            bookmarksBar.addEventListener('contextmenu', (e) => {
                if (e.target === bookmarksBar) {
                    e.preventDefault();
                    currentBookmarkId = null;
                    
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    
                    addBookmarkBtn.style.display = 'block';
                    editBookmarkBtn.style.display = 'none';
                    deleteBookmarkBtn.style.display = 'none';
                    
                    debug('æ˜¾ç¤ºå³é”®èœå• - æ·»åŠ æ–°æ”¶è—é¡¹');
                }
            });
            
            debug('æ”¶è—é¡¹äº‹ä»¶ç›‘å¬è®¾ç½®å®Œæˆ: ' + bookmarkItems.length + ' é¡¹');
        }

        // ç§»åŠ¨æ”¶è—é¡¹
        function moveBookmark(draggedId, targetId) {
            const draggedIndex = bookmarks.findIndex(b => b.id === draggedId);
            const targetIndex = bookmarks.findIndex(b => b.id === targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                const [draggedItem] = bookmarks.splice(draggedIndex, 1);
                bookmarks.splice(targetIndex, 0, draggedItem);
                
                saveBookmarks();
                renderBookmarks();
                debug('ç§»åŠ¨æ”¶è—é¡¹: ID ' + draggedId + ' ç§»åŠ¨åˆ°ä½ç½® ' + targetIndex);
            }
        }

        // æ”¶èµ·æ”¶è—æ 
        function collapseBookmarks() {
            topBookmarks.classList.add('collapsed');
            content.classList.add('collapsed');
            debugContainer.classList.add('debug-hidden');
            isDebugHidden = true;
            expandBookmarks.style.display = 'block';
            saveCollapseState();
            debug('æ”¶èµ·æ”¶è—æ å¹¶éšè—è°ƒè¯•çª—å£');
        }

        // å±•å¼€æ”¶è—æ 
        function expandBookmarksFunc() {
            topBookmarks.classList.remove('collapsed');
            content.classList.remove('collapsed');
            debugContainer.classList.remove('debug-hidden');
            isDebugHidden = false;
            expandBookmarks.style.display = 'none';
            saveCollapseState();
            debug('å±•å¼€æ”¶è—æ å¹¶æ˜¾ç¤ºè°ƒè¯•çª—å£');
        }

        // æ›´æ–°å›¾æ ‡é¢„è§ˆ
        function updateIconPreview() {
            const iconValue = bookmarkIcon.value.trim();
            iconPreview.innerHTML = '';
            
            if (iconValue) {
                if (iconValue.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = iconValue;
                    img.className = 'bookmark-icon';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.onerror = function() {
                        iconPreview.innerHTML = 'âŒ';
                        debug('å›¾æ ‡åŠ è½½å¤±è´¥: ' + iconValue);
                    };
                    iconPreview.appendChild(img);
                    debug('è®¾ç½®å›¾æ ‡URL: ' + iconValue);
                } else {
                    iconPreview.innerHTML = iconValue;
                    debug('è®¾ç½®å›¾æ ‡è¡¨æƒ…: ' + iconValue);
                }
            }
        }

        // æ˜¾ç¤ºæ·»åŠ /ç¼–è¾‘æ”¶è—é¡¹æ¨¡æ€æ¡†
        function showBookmarkModal(edit = false) {
            isEditing = edit;
            
            if (edit && currentBookmarkId) {
                modalTitle.textContent = 'ç¼–è¾‘æ”¶è—';
                const bookmark = bookmarks.find(b => b.id === currentBookmarkId);
                if (bookmark) {
                    bookmarkName.value = bookmark.name;
                    bookmarkUrl.value = bookmark.url;
                    bookmarkIcon.value = bookmark.icon || '';
                    updateIconPreview();
                }
                debug('æ˜¾ç¤ºç¼–è¾‘æ”¶è—é¡¹æ¨¡æ€æ¡† - ID: ' + currentBookmarkId);
            } else {
                modalTitle.textContent = 'æ·»åŠ æ”¶è—';
                bookmarkName.value = '';
                bookmarkUrl.value = '';
                bookmarkIcon.value = '';
                updateIconPreview();
                debug('æ˜¾ç¤ºæ·»åŠ æ”¶è—é¡¹æ¨¡æ€æ¡†');
            }
            
            bookmarkModal.style.display = 'flex';
        }

        // ä¿å­˜æ”¶è—é¡¹
        async function saveBookmark() {
            const name = bookmarkName.value.trim();
            const url = bookmarkUrl.value.trim();
            const icon = bookmarkIcon.value.trim();
            
            if (!url) {
                alert('è¯·å¡«å†™ç½‘å€');
                debug('ä¿å­˜å¤±è´¥: ç½‘å€ä¸ºç©º');
                return;
            }
            
            let formattedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                formattedUrl = 'https://' + url;
            }
            
            let finalIcon = icon;
            
            if (!finalIcon) {
                debug('æœªæä¾›å›¾æ ‡ï¼Œå°è¯•è‡ªåŠ¨è·å–ç½‘ç«™å›¾æ ‡');
                finalIcon = await getFavicon(formattedUrl);
            }
            
            if (isEditing && currentBookmarkId) {
                const index = bookmarks.findIndex(b => b.id === currentBookmarkId);
                if (index !== -1) {
                    bookmarks[index].name = name;
                    bookmarks[index].url = formattedUrl;
                    bookmarks[index].icon = finalIcon;
                    debug('æ›´æ–°æ”¶è—é¡¹ - ID: ' + currentBookmarkId);
                }
            } else {
                const newId = bookmarks.length > 0 ? Math.max(...bookmarks.map(b => b.id)) + 1 : 1;
                bookmarks.push({
                    id: newId,
                    name,
                    url: formattedUrl,
                    icon: finalIcon
                });
                debug('æ·»åŠ æ–°æ”¶è—é¡¹ - ID: ' + newId);
            }
            
            saveBookmarks();
            renderBookmarks();
            bookmarkModal.style.display = 'none';
        }

        // è·å–ç½‘ç«™å›¾æ ‡
        async function getFavicon(url) {
            try {
                const domain = new URL(url).hostname;
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                
                return await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        debug('æˆåŠŸè·å–ç½‘ç«™å›¾æ ‡: ' + faviconUrl);
                        resolve(faviconUrl);
                    };
                    img.onerror = () => {
                        debug('æ— æ³•è·å–ç½‘ç«™å›¾æ ‡ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
                        resolve('âŒ');
                    };
                    img.src = faviconUrl;
                });
            } catch (error) {
                debug('è·å–ç½‘ç«™å›¾æ ‡æ—¶å‡ºé”™: ' + error);
                return 'âŒ';
            }
        }

        // åˆ é™¤æ”¶è—é¡¹
        function deleteBookmark() {
            if (currentBookmarkId && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—é¡¹å—ï¼Ÿ')) {
                bookmarks = bookmarks.filter(b => b.id !== currentBookmarkId);
                saveBookmarks();
                renderBookmarks();
                debug('åˆ é™¤æ”¶è—é¡¹ - ID: ' + currentBookmarkId);
            }
        }

        // è§£æä¹¦ç­¾HTMLæ–‡ä»¶
        function parseBookmarksHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const links = doc.querySelectorAll('a');
            bookmarks = [];
            
            links.forEach(link => {
                const href = link.getAttribute('href');
                const text = link.textContent;
                
                if (href && href.startsWith('http')) {
                    const newId = bookmarks.length > 0 ? Math.max(...bookmarks.map(b => b.id)) + 1 : 1;
                    bookmarks.push({
                        id: newId,
                        name: text.length > 20 ? text.substring(0, 20) : text,
                        url: href,
                        icon: 'ğŸ”—'
                    });
                }
            });
            
            if (bookmarks.length === 0) {
                bookmarks = [...defaultBookmarks];
                alert('æœªæ‰¾åˆ°æ›¸ç°½æˆ–æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²æ¢å¾©é»˜èªæ›¸ç±¤');
                debug('å¯¼å…¥å¤±è´¥: æœªæ‰¾åˆ°æœ‰æ•ˆä¹¦ç­¾ï¼Œæ¢å¤é»˜è®¤');
            } else {
                debug('æˆåŠŸå¯¼å…¥ä¹¦ç­¾: ' + bookmarks.length + ' é¡¹');
            }
            
            saveBookmarks();
            renderBookmarks();
        }

        // åŠ è½½æ”¶èµ·çŠ¶æ€
        function loadCollapseState() {
            const isCollapsed = localStorage.getItem('bookmarksCollapsed') === 'true';
            if (isCollapsed) {
                collapseBookmarks();
                debug('åŠ è½½æ”¶èµ·çŠ¶æ€: å·²æ”¶èµ·');
            } else {
                expandBookmarks.style.display = 'none';
                debug('åŠ è½½æ”¶èµ·çŠ¶æ€: æœªæ”¶èµ·');
            }
            
            const isDebugHidden = localStorage.getItem('debugHidden') === 'true';
            if (isDebugHidden) {
                debugContainer.classList.add('debug-hidden');
                debugHide.textContent = '+';
                isDebugHidden = true;
                debug('åŠ è½½è°ƒè¯•çª—å£çŠ¶æ€: å·²éšè—');
            }
        }

        // ä¿å­˜æ”¶èµ·çŠ¶æ€
        function saveCollapseState() {
            localStorage.setItem('bookmarksCollapsed', topBookmarks.classList.contains('collapsed'));
            debug('ä¿å­˜æ”¶èµ·çŠ¶æ€: ' + (topBookmarks.classList.contains('collapsed') ? 'å·²æ”¶èµ·' : 'æœªæ”¶èµ·'));
            
            localStorage.setItem('debugHidden', isDebugHidden);
        }

        // è®¾ç½®è°ƒè¯•çª—å£æ§åˆ¶
        function setupDebugControls() {
            debugOpacity.addEventListener('input', function() {
                const opacity = this.value / 100;
                debugContainer.style.opacity = opacity;
                debug('è®¾ç½®è°ƒè¯•çª—å£é€æ˜åº¦: ' + (opacity * 100) + '%');
            });
            
            debugToggle.addEventListener('click', function() {
                if (isDebugCollapsed) {
                    debugContainer.classList.remove('debug-collapsed');
                    debugToggle.textContent = 'âˆ’';
                    isDebugCollapsed = false;
                    debug('å±•å¼€è°ƒè¯•çª—å£');
                } else {
                    debugContainer.classList.add('debug-collapsed');
                    debugToggle.textContent = '+';
                    isDebugCollapsed = true;
                    debug('æŠ˜å è°ƒè¯•çª—å£');
                }
            });
            
            debugHide.addEventListener('click', function() {
                if (isDebugHidden) {
                    debugContainer.classList.remove('debug-hidden');
                    debugHide.textContent = 'Ã—';
                    isDebugHidden = false;
                    debug('æ˜¾ç¤ºè°ƒè¯•çª—å£');
                } else {
                    debugContainer.classList.add('debug-hidden');
                    debugHide.textContent = '+';
                    isDebugHidden = true;
                    debug('éšè—è°ƒè¯•çª—å£');
                }
            });
            
            makeElementDraggable(debugContainer, debugHeader);
            debug('è°ƒè¯•çª—å£æ§åˆ¶è®¾ç½®å®Œæˆ');
        }

        // ä½¿å…ƒç´ å¯æ‹–åŠ¨
        function makeElementDraggable(element, handle) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            function startDrag(e) {
                isDragging = true;
                const rect = element.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                startX = e.clientX;
                startY = e.clientY;
                e.preventDefault();
                debug('å¼€å§‹æ‹–åŠ¨è°ƒè¯•çª—å£');
            }
            
            function drag(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.style.transform = `translate(${dx}px, ${dy}px)`;
            }
            
            function stopDrag() {
                if (!isDragging) return;
                const transform = element.style.transform;
                const matches = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                
                if (matches) {
                    const dx = parseFloat(matches[1]);
                    const dy = parseFloat(matches[2]);
                    let newX = initialX + dx;
                    let newY = initialY + dy;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const elementWidth = element.offsetWidth;
                    const elementHeight = element.offsetHeight;
                    newX = Math.max(0, Math.min(newX, viewportWidth - elementWidth));
                    newY = Math.max(0, Math.min(newY, viewportHeight - elementHeight));
                    element.style.left = newX + 'px';
                    element.style.top = newY + 'px';
                    element.style.transform = 'none';
                    element.style.right = 'auto';
                    element.style.bottom = 'auto';
                }
                
                isDragging = false;
                debug('åœæ­¢æ‹–åŠ¨è°ƒè¯•çª—å£ï¼Œä½ç½®å·²é™åˆ¶åœ¨è§†å£å†…');
            }
        }

        // è°ƒè¯•å‡½æ•°
        function debug(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(message);
        }
    </script>
</body>
</html>
