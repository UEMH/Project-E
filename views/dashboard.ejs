<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEMH_HP - <%= user.username %></title>
    <!-- diy by developer - ç½‘é¡µå›¾æ ‡è®¾ç½® -->
    <!-- æ¨èå°ºå¯¸ï¼š32x32px æˆ– 16x16pxï¼Œæ ¼å¼ï¼šICOã€PNG -->
    <link rel="icon" type="image/x-icon" href="/images/cat.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            overflow: auto;
        }
        
        /* ç”¨æˆ·ä¿¡æ¯æ æ ·å¼ */
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* diy by developer - èƒŒæ™¯å›¾ç‰‡è·¯å¾„ */
            background-image: url('/images/Night_copy.jpg');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 1;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 24px;
            color: white;
            background: #222;
        }
        
        .error-message {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            max-width: 80%;
            margin: 20% auto;
        }
        
        .content {
            position: relative;
            z-index: 1;
            color: white;
            text-align: center;
            padding-top: 70px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transition: padding-top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .content.collapsed {
            padding-top: 40px;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        p {
            font-size: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* å›ºå®šåœ¨é¡¶éƒ¨çš„ä¹¦ç­¾æ æ ·å¼ */
        .top-bookmarks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .top-bookmarks.collapsed {
            height: 0;
            padding: 0;
            background: transparent;
            backdrop-filter: none;
            box-shadow: none;
        }
        
        .bookmarks-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .bookmarks-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 60px;
            overflow-y: auto;
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .top-bookmarks.collapsed .bookmarks-bar {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }
        
        .bookmark-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 6px 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bookmark-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .bookmark-item.dragging {
            opacity: 0.7;
            transform: scale(1.05);
        }
        
        .bookmark-item a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        /* ç»Ÿä¸€å›¾æ ‡æ ·å¼ - å¤§å°å¢åŠ 10%å¹¶ç¡®ä¿æ¯”ä¾‹æ­£ç¡® */
        .icon-container {
            width: 18px; /* å¢åŠ 10% */
            height: 18px; /* å¢åŠ 10% */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border-radius: 2px;
        }
        
        .bookmark-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .emoji-icon {
            font-size: 15px; /* å¢åŠ 10% */
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bookmarks-header-buttons {
            display: flex;
            gap: 8px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .top-bookmarks.collapsed .bookmarks-header-buttons {
            opacity: 0;
            pointer-events: none;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .file-input {
            display: none;
        }
        
        /* æ”¶è—å¤¹æ”¶èµ·æ—¶çš„å±•å¼€æŒ‰é’® */
        .expand-bookmarks {
            position: fixed;
            top: 5px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            z-index: 101;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .expand-bookmarks:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .top-bookmarks.collapsed + .expand-bookmarks {
            display: flex;
        }
        
        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            min-width: 180px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: white;
        }
        
        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 5px 0;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(40, 40, 40, 0.95);
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            opacity: 0.8;
            color: white;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .icon-preview {
            width: 32px;
            height: 32px;
            margin-top: 5px;
            object-fit: contain;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .help-content {
            color: white;
            line-height: 1.6;
            text-align: center;
        }
        
        .help-content h2 {
            margin-bottom: 15px;
            color: #4FC3F7;
        }
        
        .help-content ul {
            text-align: left;
            padding-left: 20px;
            margin-bottom: 20px;
        }
        
        .help-content li {
            margin-bottom: 10px;
        }
        
        /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        .debug-container {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            transform: translate(0, 0); /* ç”¨äºå¹³æ»‘æ‹–åŠ¨ */
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5);
            cursor: move;
        }
        
        .debug-title {
            font-weight: bold;
        }
        
        .debug-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .debug-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .debug-info {
            flex: 1;
            overflow-y: auto;
            padding: 5px 10px;
        }
        
        .debug-slider-container {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            gap: 5px;
        }
        
        .debug-slider {
            flex: 1;
            height: 5px;
            appearance: none;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }
        
        /* ç»Ÿä¸€æ»‘å—è‰²è°ƒ */
        .debug-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50; /* ç»Ÿä¸€ä½¿ç”¨ä¸æŒ‰é’®ç›¸åŒçš„è‰²è°ƒ */
            cursor: pointer;
        }
        
        .debug-hidden {
            display: none;
        }
        
        .debug-collapsed .debug-info,
        .debug-collapsed .debug-slider-container {
            display: none;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            p { font-size: 1.2rem; }
            .bookmarks-bar { max-height: 80px; }
            .content { padding-top: 150px; }
            .content.collapsed { padding-top: 60px; }
            .bookmarks-container { flex-direction: column; align-items: flex-start; }
            .bookmarks-header-buttons { margin-left: 0; margin-top: 10px; }
            .debug-container { width: 250px; }
            .user-info { top: 5px; right: 5px; padding: 5px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div class="user-info">
        <span>æ¬¢è¿, <%= user.username %></span>
        <form action="/logout" method="POST" style="display: inline;">
            <button type="submit" class="logout-btn">æ³¨é”€</button>
        </form>
    </div>

    <!-- å›ºå®šåœ¨é¡¶éƒ¨çš„ä¹¦ç­¾æ  -->
    <div class="top-bookmarks" id="topBookmarks">
        <div class="bookmarks-container">
            <div class="bookmarks-bar" id="bookmarksBar">
                <!-- ä¹¦ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="bookmarks-header-buttons">
                <button class="header-btn" id="importBookmarks" title="å¯¼å…¥æ”¶è—å¤¹">ğŸš©</button>
                <button class="header-btn" id="helpBtn" title="ä½¿ç”¨è¯´æ˜">â“</button>
                <button class="header-btn" id="collapseBtn" title="æ”¶èµ·æ”¶è—å¤¾">â–²</button>
            </div>
        </div>
    </div>

    <!-- æ”¶è—å¤¹æ”¶èµ·æ—¶çš„å±•å¼€æŒ‰é’® -->
    <button class="expand-bookmarks" id="expandBookmarks" title="å±•é–‹æ”¶è—å¤¾">â–¼</button>

    <div class="background-container">
        <div class="bg-image" id="bgImage"></div>
        <div class="loading" id="loading">åœ–ç‰‡åŠ è¼‰ä¸­...</div>
        <div class="error-message" id="errorMessage">
            <h2>ç„¡æ³•åŠ è¼‰èƒŒæ™¯åœ–ç‰‡</h2>
            <p>è«‹æª¢æŸ¥åœ–ç‰‡è·¯å¾‘æ˜¯å¦æ­£ç¢º</p>
        </div>
    </div>
    
    <div class="content" id="content">
        <h1> </h1>
        <p> </p>
    </div>
    
    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="addBookmark">æ·»åŠ æ–°æ”¶è—</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="editBookmark">ç¼–è¾‘æ”¶è—</div>
        <div class="context-menu-item" id="deleteBookmark">åˆ é™¤æ”¶è—</div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘æ”¶è—é¡¹çš„æ¨¡æ€æ¡† -->
    <div class="modal" id="bookmarkModal">
        <div class="modal-content">
            <h2 id="modalTitle">æ·»åŠ æ”¶è—</h2>
            <div class="form-group">
                <label for="bookmarkName">åç§° (å¯é€‰)</label>
                <input type="text" id="bookmarkName" placeholder="è¾“å…¥æ”¶è—åç§° (ç•™ç©ºåˆ™ä»…æ˜¾ç¤ºå›¾æ ‡)">
            </div>
            <div class="form-group">
                <label for="bookmarkUrl">ç½‘å€</label>
                <input type="text" id="bookmarkUrl" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label for="bookmarkIcon">å›¾æ ‡ (å¯é€‰ - è¾“å…¥å›¾ç‰‡URLæˆ–è¡¨æƒ…ç¬¦å·)</label>
                <input type="text" id="bookmarkIcon" placeholder="è¾“å…¥å›¾ç‰‡URLæˆ–è¡¨æƒ…ç¬¦å·">
                <div class="icon-preview" id="iconPreview"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBookmark">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveBookmark">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¸®åŠ©è¯´æ˜æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="help-content">
                <h2>æ­¡è¿ä½¿ç”¨ä¸»é </h2>
                <p>é€™æ˜¯ä¸€å€‹ç°¡æ½”ç¾è§€çš„ç€è¦½å™¨èµ·å§‹é ï¼Œæ”¶è—å¤¾å›ºå®šåœ¨é ‚éƒ¨æ–¹ä¾¿è¨ªå•</p>
                
                <h3>ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>å·¦é”®ç‚¹å‡» - è®¿é—®ç½‘ç«™</li>
                    <li>å·¦é”®æ‹–æ‹½ - é‡æ–°æ’åºæ”¶è—é¡¹</li>
                    <li>å³é”®ç‚¹å‡»æ”¶è—é¡¹ - ç¼–è¾‘æˆ–åˆ é™¤</li>
                    <li>å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸ - æ·»åŠ æ–°æ”¶è—é¡¹</li>
                    <li>æ‰€æœ‰æ›´æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨å’ŒæœåŠ¡å™¨ä¸­</li>
                    <li>æ”¶è—é¡¹å¯ä»¥ä»…æ˜¾ç¤ºå›¾æ ‡ï¼Œæ— éœ€åç§°</li>
                    <li>æ·»åŠ ä¹¦ç­¾æ—¶å¦‚æœä¸æä¾›å›¾æ ‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•è·å–ç½‘ç«™å›¾æ ‡</li>
                    <li>å½“å‰ç”¨æˆ·: <strong><%= user.username %></strong> (<%= user.email %>)</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="closeHelp">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯å®¹å™¨ -->
    <div class="debug-container" id="debugContainer">
        <div class="debug-header" id="debugHeader">
            <div class="debug-title">è°ƒè¯•ä¿¡æ¯</div>
            <div class="debug-controls">
                <button class="debug-toggle" id="debugToggle">âˆ’</button>
                <button class="debug-toggle" id="debugHide">Ã—</button>
            </div>
        </div>
        <div class="debug-info" id="debugInfo"></div>
        <div class="debug-slider-container">
            <span>é€æ˜åº¦:</span>
            <!-- diy by developer - è°ƒè¯•çª—å£é€æ˜åº¦åˆå§‹å€¼ -->
            <input type="range" min="0" max="100" value="70" class="debug-slider" id="debugOpacity">
        </div>
    </div>

    <script>
        // è°ƒè¯•å‡½æ•°
        function debug(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(message);
        }

        // åˆå§‹æ”¶è—é¡¹æ•°æ® - ä»æœåŠ¡å™¨è·å–
        const serverBookmarks = JSON.parse('<%- JSON.stringify(bookmarks || []) %>');
        const defaultBookmarks = serverBookmarks.length > 0 ? serverBookmarks : [
            { id: 1, name: "Google", url: "https://www.google.com", icon: "https://favicon.pub/google.com" },
            { id: 2, name: "YouTube", url: "https://www.youtube.com", icon: "https://favicon.pub/youtube.com" },
            { id: 3, name: "GitHub", url: "https://github.com", icon: "https://favicon.pub/github.com" },
            { id: 4, name: "", url: "https://homdgcat.wiki/sr/char?lang=CH", icon: "https://favicon.is/homdgcat.wiki" },
            { id: 5, name: "è¡¨æƒ…ç¬¦å·", url: "https://example.com", icon: "ğŸ”" }
        ];

        // DOMå…ƒç´ 
        let topBookmarks, bookmarksBar, contextMenu, bookmarkModal, helpModal;
        let modalTitle, bookmarkName, bookmarkUrl, bookmarkIcon, iconPreview;
        let saveBookmarkBtn, cancelBookmarkBtn, addBookmarkBtn, editBookmarkBtn, deleteBookmarkBtn;
        let importBookmarksBtn, bookmarkFile, helpBtn, collapseBtn, expandBookmarks, content, closeHelp;
        let debugContainer, debugInfo, debugToggle, debugHide, debugOpacity, debugHeader;

        // å…¨å±€å˜é‡
        let bookmarks = [];
        let currentBookmarkId = null;
        let isEditing = false;
        let isDebugCollapsed = false;
        let isDebugHidden = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            debug('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            debug('å½“å‰ç”¨æˆ·: <%= user.username %> (<%= user.email %>)');
            
            // åˆå§‹åŒ–DOMå…ƒç´ 
            initDOMElements();
            
            // åŠ è½½æ”¶è—é¡¹
            loadBookmarks();
            renderBookmarks();
            setupEventListeners();
            loadCollapseState();
            setupDebugControls();
            
            // å›¾ç‰‡åŠ è½½å¤„ç†
            const loading = document.getElementById('loading');
            const bgImage = document.getElementById('bgImage');
            const errorMessage = document.getElementById('errorMessage');
            
            // åˆ›å»ºæµ‹è¯•å›¾ç‰‡ä»¥æ£€æŸ¥æ˜¯å¦å¯åŠ è½½
            const testImage = new Image();
            testImage.onload = function() {
                // å›¾ç‰‡åŠ è½½æˆåŠŸ
                loading.style.display = 'none';
                bgImage.style.opacity = '1';
                debug('èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ');
            };
            
            testImage.onerror = function() {
                // å›¾ç‰‡åŠ è½½å¤±è´¥
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                debug('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥');
            };
            
            // ä½¿ç”¨èƒŒæ™¯å›¾ç‰‡çš„URLæµ‹è¯•
            const bgUrl = window.getComputedStyle(bgImage).backgroundImage;
            // æå–URL
            const urlMatch = bgUrl.match(/url\(["']?(.*?)["']?\)/);
            if (urlMatch && urlMatch[1]) {
                testImage.src = urlMatch[1];
            } else {
                // å¦‚æœæ— æ³•æå–URLï¼Œç›´æ¥éšè—åŠ è½½æç¤º
                loading.style.display = 'none';
                debug('æ— æ³•æå–èƒŒæ™¯å›¾ç‰‡URL');
            }
        });

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initDOMElements() {
            debug('åˆå§‹åŒ–DOMå…ƒç´ ');
            
            topBookmarks = document.getElementById('topBookmarks');
            bookmarksBar = document.getElementById('bookmarksBar');
            contextMenu = document.getElementById('contextMenu');
            bookmarkModal = document.getElementById('bookmarkModal');
            helpModal = document.getElementById('helpModal');
            modalTitle = document.getElementById('modalTitle');
            bookmarkName = document.getElementById('bookmarkName');
            bookmarkUrl = document.getElementById('bookmarkUrl');
            bookmarkIcon = document.getElementById('bookmarkIcon');
            iconPreview = document.getElementById('iconPreview');
            saveBookmarkBtn = document.getElementById('saveBookmark');
            cancelBookmarkBtn = document.getElementById('cancelBookmark');
            addBookmarkBtn = document.getElementById('addBookmark');
            editBookmarkBtn = document.getElementById('editBookmark');
            deleteBookmarkBtn = document.getElementById('deleteBookmark');
            importBookmarksBtn = document.getElementById('importBookmarks');
            helpBtn = document.getElementById('helpBtn');
            collapseBtn = document.getElementById('collapseBtn');
            expandBookmarks = document.getElementById('expandBookmarks');
            content = document.getElementById('content');
            closeHelp = document.getElementById('closeHelp');
            
            // è°ƒè¯•ç›¸å…³å…ƒç´ 
            debugContainer = document.getElementById('debugContainer');
            debugInfo = document.getElementById('debugInfo');
            debugToggle = document.getElementById('debugToggle');
            debugHide = document.getElementById('debugHide');
            debugOpacity = document.getElementById('debugOpacity');
            debugHeader = document.getElementById('debugHeader');
            
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            bookmarkFile = document.createElement('input');
            bookmarkFile.type = 'file';
            bookmarkFile.id = 'bookmarkFile';
            bookmarkFile.className = 'file-input';
            bookmarkFile.accept = '.html';
            document.body.appendChild(bookmarkFile);
            
            debug('DOMå…ƒç´ åˆå§‹åŒ–å®Œæˆ');
        }

        // è®¾ç½®è°ƒè¯•çª—å£æ§åˆ¶
        function setupDebugControls() {
            // é€æ˜åº¦æ»‘å—
            debugOpacity.addEventListener('input', function() {
                const opacity = this.value / 100;
                debugContainer.style.opacity = opacity;
                debug('è®¾ç½®è°ƒè¯•çª—å£é€æ˜åº¦: ' + (opacity * 100) + '%');
            });
            
            // åˆ‡æ¢è°ƒè¯•çª—å£æŠ˜å çŠ¶æ€
            debugToggle.addEventListener('click', function() {
                if (isDebugCollapsed) {
                    debugContainer.classList.remove('debug-collapsed');
                    debugToggle.textContent = 'âˆ’';
                    isDebugCollapsed = false;
                    debug('å±•å¼€è°ƒè¯•çª—å£');
                } else {
                    debugContainer.classList.add('debug-collapsed');
                    debugToggle.textContent = '+';
                    isDebugCollapsed = true;
                    debug('æŠ˜å è°ƒè¯•çª—å£');
                }
            });
            
            // åˆ‡æ¢è°ƒè¯•çª—å£å¯è§æ€§
            debugHide.addEventListener('click', function() {
                if (isDebugHidden) {
                    debugContainer.classList.remove('debug-hidden');
                    debugHide.textContent = 'Ã—';
                    isDebugHidden = false;
                    debug('æ˜¾ç¤ºè°ƒè¯•çª—å£');
                } else {
                    debugContainer.classList.add('debug-hidden');
                    debugHide.textContent = '+';
                    isDebugHidden = true;
                    debug('éšè—è°ƒè¯•çª—å£');
                }
            });
            
            // ä½¿è°ƒè¯•çª—å£å¯æ‹–åŠ¨ - ä¼˜åŒ–ç‰ˆæœ¬ï¼ŒåŒ…å«è¾¹ç•Œé™åˆ¶
            makeElementDraggable(debugContainer, debugHeader);
            
            debug('è°ƒè¯•çª—å£æ§åˆ¶è®¾ç½®å®Œæˆ');
        }

        // ä½¿å…ƒç´ å¯æ‹–åŠ¨ - ä¼˜åŒ–ç‰ˆæœ¬ï¼ŒåŒ…å«è¾¹ç•Œé™åˆ¶
        function makeElementDraggable(element, handle) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            function startDrag(e) {
                isDragging = true;
                
                // è·å–åˆå§‹ä½ç½®
                const rect = element.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                
                // è®°å½•é¼ æ ‡èµ·å§‹ä½ç½®
                startX = e.clientX;
                startY = e.clientY;
                
                // é˜²æ­¢é€‰æ‹©æ–‡æœ¬
                e.preventDefault();
                
                debug('å¼€å§‹æ‹–åŠ¨è°ƒè¯•çª—å£');
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                // è®¡ç®—ç§»åŠ¨è·ç¦»
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // ä½¿ç”¨transformå®ç°æ›´æµç•…çš„ç§»åŠ¨
                element.style.transform = `translate(${dx}px, ${dy}px)`;
            }
            
            function stopDrag() {
                if (!isDragging) return;
                
                // è·å–å½“å‰transformå€¼
                const transform = element.style.transform;
                const matches = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                
                if (matches) {
                    const dx = parseFloat(matches[1]);
                    const dy = parseFloat(matches[2]);
                    
                    // è®¡ç®—æ–°ä½ç½®
                    let newX = initialX + dx;
                    let newY = initialY + dy;
                    
                    // è·å–è§†å£å’Œå…ƒç´ å°ºå¯¸
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const elementWidth = element.offsetWidth;
                    const elementHeight = element.offsetHeight;
                    
                    // é™åˆ¶å…ƒç´ ä¸è¶…å‡ºè§†å£è¾¹ç•Œ
                    newX = Math.max(0, Math.min(newX, viewportWidth - elementWidth));
                    newY = Math.max(0, Math.min(newY, viewportHeight - elementHeight));
                    
                    // åº”ç”¨æœ€ç»ˆä½ç½®
                    element.style.left = newX + 'px';
                    element.style.top = newY + 'px';
                    element.style.transform = 'none';
                    element.style.right = 'auto';
                    element.style.bottom = 'auto';
                }
                
                isDragging = false;
                debug('åœæ­¢æ‹–åŠ¨è°ƒè¯•çª—å£ï¼Œä½ç½®å·²é™åˆ¶åœ¨è§†å£å†…');
            }
            
            // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
            handle.addEventListener('touchstart', function(e) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                startDrag(mouseEvent);
            });
            
            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drag(mouseEvent);
            });
            
            document.addEventListener('touchend', stopDrag);
        }

        // åŠ è½½æ”¶è—é¡¹
        function loadBookmarks() {
            const savedBookmarks = localStorage.getItem('customBookmarks');
            if (savedBookmarks) {
                bookmarks = JSON.parse(savedBookmarks);
                debug('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ”¶è—é¡¹: ' + bookmarks.length + ' é¡¹');
            } else {
                bookmarks = [...defaultBookmarks];
                saveBookmarks();
                debug('ä½¿ç”¨é»˜è®¤æ”¶è—é¡¹');
            }
        }

        // ä¿å­˜æ”¶è—é¡¹åˆ°æœ¬åœ°å­˜å‚¨å’ŒæœåŠ¡å™¨
        function saveBookmarks() {
            localStorage.setItem('customBookmarks', JSON.stringify(bookmarks));
            debug('ä¿å­˜æ”¶è—é¡¹åˆ°æœ¬åœ°å­˜å‚¨: ' + bookmarks.length + ' é¡¹');
            
            // åŒæ—¶ä¿å­˜åˆ°æœåŠ¡å™¨
            saveBookmarksToServer();
        }

        // ä¿å­˜ä¹¦ç­¾åˆ°æœåŠ¡å™¨
        async function saveBookmarksToServer() {
            try {
                // å°†ä¹¦ç­¾è½¬æ¢ä¸ºé€‚åˆæœåŠ¡å™¨çš„æ ¼å¼
                const bookmarksForServer = bookmarks.map(bm => ({
                    name: bm.name,
                    url: bm.url,
                    icon: bm.icon
                }));
                
                // å‘é€åˆ°æœåŠ¡å™¨
                const response = await fetch('/bookmarks/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bookmarks: bookmarksForServer })
                });
                
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨ä¿å­˜å¤±è´¥');
                }
                
                const result = await response.json();
                debug('ä¹¦ç­¾å·²åŒæ­¥åˆ°æœåŠ¡å™¨: ' + result.message);
            } catch (error) {
                debug('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥: ' + error.message);
                // å¯ä»¥æ·»åŠ é‡è¯•é€»è¾‘æˆ–ç”¨æˆ·æç¤º
            }
        }

        // åŠ è½½æ”¶èµ·çŠ¶æ€
        function loadCollapseState() {
            const isCollapsed = localStorage.getItem('bookmarksCollapsed') === 'true';
            if (isCollapsed) {
                collapseBookmarks();
                debug('åŠ è½½æ”¶èµ·çŠ¶æ€: å·²æ”¶èµ·');
            } else {
                debug('åŠ è½½æ”¶èµ·çŠ¶æ€: æœªæ”¶èµ·');
            }
            
            // diy by developer - åŠ è½½è°ƒè¯•çª—å£å¯è§æ€§çŠ¶æ€
            const isDebugHidden = localStorage.getItem('debugHidden') === 'true';
            if (isDebugHidden) {
                debugContainer.classList.add('debug-hidden');
                debugHide.textContent = '+';
                isDebugHidden = true;
                debug('åŠ è½½è°ƒè¯•çª—å£çŠ¶æ€: å·²éšè—');
            }
        }

        // ä¿å­˜æ”¶èµ·çŠ¶æ€
        function saveCollapseState() {
            localStorage.setItem('bookmarksCollapsed', topBookmarks.classList.contains('collapsed'));
            debug('ä¿å­˜æ”¶èµ·çŠ¶æ€: ' + (topBookmarks.classList.contains('collapsed') ? 'å·²æ”¶èµ·' : 'æœªæ”¶èµ·'));
            
            // diy by developer - ä¿å­˜è°ƒè¯•çª—å£å¯è§æ€§çŠ¶æ€
            localStorage.setItem('debugHidden', isDebugHidden);
        }

        // æ¸²æŸ“æ”¶è—é¡¹ - æ›´æ–°å›¾æ ‡å¤„ç†ï¼Œç¡®ä¿æ¯”ä¾‹æ­£ç¡®
        function renderBookmarks() {
            bookmarksBar.innerHTML = '';
            
            bookmarks.forEach(bookmark => {
                const bookmarkElement = document.createElement('div');
                bookmarkElement.className = 'bookmark-item';
                bookmarkElement.setAttribute('data-id', bookmark.id);
                bookmarkElement.draggable = true;
                
                // æ£€æŸ¥å›¾æ ‡æ˜¯URLè¿˜æ˜¯è¡¨æƒ…ç¬¦å·
                let iconHTML = '';
                if (bookmark.icon) {
                    if (bookmark.icon.startsWith('http')) {
                        // å›¾ç‰‡å›¾æ ‡ - ä½¿ç”¨å›ºå®šå¤§å°çš„å®¹å™¨ï¼Œç¡®ä¿æ¯”ä¾‹æ­£ç¡®
                        iconHTML = `
                            <div class="icon-container">
                                <img src="${bookmark.icon}" class="bookmark-icon" alt="${bookmark.name}" onerror="handleIconError(this)">
                            </div>
                        `;
                    } else {
                        // è¡¨æƒ…ç¬¦å· - ä½¿ç”¨å›ºå®šå¤§å°çš„å®¹å™¨
                        iconHTML = `
                            <div class="icon-container">
                                <span class="emoji-icon">${bookmark.icon}</span>
                            </div>
                        `;
                    }
                } else {
                    // é»˜è®¤å›¾æ ‡
                    iconHTML = `
                        <div class="icon-container">
                            <span class="emoji-icon">ğŸ”—</span>
                        </div>
                    `;
                }
                
                // å¦‚æœåç§°ä¸ºç©ºï¼Œåªæ˜¾ç¤ºå›¾æ ‡
                if (!bookmark.name || bookmark.name.trim() === '') {
                    bookmarkElement.innerHTML = `
                        <a href="${bookmark.url}" target="_blank" title="${bookmark.url}">${iconHTML}</a>
                    `;
                } else {
                    bookmarkElement.innerHTML = `
                        ${iconHTML}
                        <a href="${bookmark.url}" target="_blank">${bookmark.name}</a>
                    `;
                }
                
                bookmarksBar.appendChild(bookmarkElement);
            });
            
            setupBookmarkEvents();
            debug('æ¸²æŸ“æ”¶è—é¡¹å®Œæˆ: ' + bookmarks.length + ' é¡¹');
        }

        // å¤„ç†å›¾æ ‡åŠ è½½é”™è¯¯
        function handleIconError(imgElement) {
            const container = imgElement.parentNode;
            container.innerHTML = '<span class="emoji-icon">âŒ</span>';
            debug('å›¾æ ‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å›¾æ ‡');
        }

        // è®¾ç½®æ”¶è—é¡¹äº‹ä»¶ç›‘å¬
        function setupBookmarkEvents() {
            const bookmarkItems = document.querySelectorAll('.bookmark-item');
            
            bookmarkItems.forEach(item => {
                // å·¦é”®ç‚¹å‡» - æ‰“å¼€é“¾æ¥
                item.addEventListener('click', (e) => {
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨é“¾æ¥çš„é»˜è®¤è¡Œä¸º
                    e.preventDefault();
                    
                    const id = parseInt(item.getAttribute('data-id'));
                    const bookmark = bookmarks.find(b => b.id === id);
                    if (bookmark) {
                        window.open(bookmark.url, '_blank');
                        debug('æ‰“å¼€é“¾æ¥: ' + bookmark.url);
                    }
                });
                
                // å³é”®ç‚¹å‡» - æ˜¾ç¤ºèœå•
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    currentBookmarkId = parseInt(item.getAttribute('data-id'));
                    
                    // æ˜¾ç¤ºèœå•
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    
                    // éšè—æ·»åŠ é€‰é¡¹ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤
                    addBookmarkBtn.style.display = 'none';
                    editBookmarkBtn.style.display = 'block';
                    deleteBookmarkBtn.style.display = 'block';
                    
                    debug('æ˜¾ç¤ºå³é”®èœå• - ç¼–è¾‘æ”¶è—é¡¹ ID: ' + currentBookmarkId);
                });
                
                // æ‹–æ‹½äº‹ä»¶
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.getAttribute('data-id'));
                    debug('å¼€å§‹æ‹–æ‹½æ”¶è—é¡¹ ID: ' + item.getAttribute('data-id'));
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    debug('ç»“æŸæ‹–æ‹½æ”¶è—é¡¹');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = parseInt(item.getAttribute('data-id'));
                    
                    if (draggedId !== targetId) {
                        moveBookmark(draggedId, targetId);
                    }
                });
            });
            
            // ç©ºç™½åŒºåŸŸå³é”®ç‚¹å‡» - æ˜¾ç¤ºæ·»åŠ èœå•
            bookmarksBar.addEventListener('contextmenu', (e) => {
                if (e.target === bookmarksBar) {
                    e.preventDefault();
                    currentBookmarkId = null;
                    
                    // æ˜¾ç¤ºèœå•
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    
                    // æ˜¾ç¤ºæ·»åŠ é€‰é¡¹ï¼Œéšè—ç¼–è¾‘å’Œåˆ é™¤
                    addBookmarkBtn.style.display = 'block';
                    editBookmarkBtn.style.display = 'none';
                    deleteBookmarkBtn.style.display = 'none';
                    
                    debug('æ˜¾ç¤ºå³é”®èœå• - æ·»åŠ æ–°æ”¶è—é¡¹');
                }
            });
            
            debug('æ”¶è—é¡¹äº‹ä»¶ç›‘å¬è®¾ç½®å®Œæˆ: ' + bookmarkItems.length + ' é¡¹');
        }

        // ç§»åŠ¨æ”¶è—é¡¹ï¼ˆé‡æ–°æ’åºï¼‰
        function moveBookmark(draggedId, targetId) {
            const draggedIndex = bookmarks.findIndex(b => b.id === draggedId);
            const targetIndex = bookmarks.findIndex(b => b.id === targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                const [draggedItem] = bookmarks.splice(draggedIndex, 1);
                bookmarks.splice(targetIndex, 0, draggedItem);
                
                saveBookmarks();
                renderBookmarks();
                debug('ç§»åŠ¨æ”¶è—é¡¹: ID ' + draggedId + ' ç§»åŠ¨åˆ°ä½ç½® ' + targetIndex);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            debug('å¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
            
            // å³é”®èœå•é€‰é¡¹
            addBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                showBookmarkModal();
                debug('ç‚¹å‡»æ·»åŠ æ”¶è—é¡¹æŒ‰é’®');
            });
            
            editBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                showBookmarkModal(true);
                debug('ç‚¹å‡»ç¼–è¾‘æ”¶è—é¡¹æŒ‰é’®');
            });
            
            deleteBookmarkBtn.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                deleteBookmark();
                debug('ç‚¹å‡»åˆ é™¤æ”¶è—é¡¹æŒ‰é’®');
            });
            
            // æ¨¡æ€æ¡†æŒ‰é’®
            saveBookmarkBtn.addEventListener('click', saveBookmark);
            debug('ä¿å­˜æ”¶è—é¡¹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            cancelBookmarkBtn.addEventListener('click', () => {
                bookmarkModal.style.display = 'none';
                debug('ç‚¹å‡»å–æ¶ˆæŒ‰é’®');
            });
            
            // å›¾æ ‡é¢„è§ˆ
            bookmarkIcon.addEventListener('input', updateIconPreview);
            debug('å›¾æ ‡é¢„è§ˆäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            // å¯¼å…¥åŠŸèƒ½
            importBookmarksBtn.addEventListener('click', function() {
                bookmarkFile.click();
                debug('ç‚¹å‡»å¯¼å…¥æ”¶è—å¤¹æŒ‰é’®');
            });
            
            bookmarkFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseBookmarksHTML(content);
                };
                reader.readAsText(file);
                debug('é€‰æ‹©æ–‡ä»¶: ' + file.name);
            });
            
            // å¸®åŠ©æŒ‰é’®
            helpBtn.addEventListener('click', () => {
                helpModal.style.display = 'flex';
                debug('ç‚¹å‡»å¸®åŠ©æŒ‰é’®');
            });
            
            closeHelp.addEventListener('click', () => {
                helpModal.style.display = 'none';
                debug('ç‚¹å‡»å…³é—­å¸®åŠ©æŒ‰é’®');
            });
            
            // æ”¶èµ·/å±•å¼€åŠŸèƒ½
            collapseBtn.addEventListener('click', collapseBookmarks);
            expandBookmarks.addEventListener('click', expandBookmarksFunc);
            debug('æ”¶èµ·/å±•å¼€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            
            debug('æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        // æ”¶èµ·æ”¶è—æ 
        function collapseBookmarks() {
            topBookmarks.classList.add('collapsed');
            content.classList.add('collapsed');
            // diy by developer - åŒæ—¶éšè—è°ƒè¯•çª—å£
            debugContainer.classList.add('debug-hidden');
            isDebugHidden = true;
            saveCollapseState();
            debug('æ”¶èµ·æ”¶è—æ å¹¶éšè—è°ƒè¯•çª—å£');
        }

        // å±•å¼€æ”¶è—æ 
        function expandBookmarksFunc() {
            topBookmarks.classList.remove('collapsed');
            content.classList.remove('collapsed');
            // diy by developer - åŒæ—¶æ˜¾ç¤ºè°ƒè¯•çª—å£
            debugContainer.classList.remove('debug-hidden');
            isDebugHidden = false;
            saveCollapseState();
            debug('å±•å¼€æ”¶è—æ å¹¶æ˜¾ç¤ºè°ƒè¯•çª—å£');
        }

        // æ›´æ–°å›¾æ ‡é¢„è§ˆ
        function updateIconPreview() {
            const iconValue = bookmarkIcon.value.trim();
            iconPreview.innerHTML = '';
            
            if (iconValue) {
                if (iconValue.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = iconValue;
                    img.className = 'bookmark-icon';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.onerror = function() {
                        iconPreview.innerHTML = 'âŒ';
                        debug('å›¾æ ‡åŠ è½½å¤±è´¥: ' + iconValue);
                    };
                    iconPreview.appendChild(img);
                    debug('è®¾ç½®å›¾æ ‡URL: ' + iconValue);
                } else {
                    iconPreview.innerHTML = iconValue;
                    debug('è®¾ç½®å›¾æ ‡è¡¨æƒ…: ' + iconValue);
                }
            }
        }

        // æ˜¾ç¤ºæ·»åŠ /ç¼–è¾‘æ”¶è—é¡¹æ¨¡æ€æ¡†
        function showBookmarkModal(edit = false) {
            isEditing = edit;
            
            if (edit && currentBookmarkId) {
                modalTitle.textContent = 'ç¼–è¾‘æ”¶è—';
                const bookmark = bookmarks.find(b => b.id === currentBookmarkId);
                if (bookmark) {
                    bookmarkName.value = bookmark.name;
                    bookmarkUrl.value = bookmark.url;
                    bookmarkIcon.value = bookmark.icon || '';
                    updateIconPreview();
                }
                debug('æ˜¾ç¤ºç¼–è¾‘æ”¶è—é¡¹æ¨¡æ€æ¡† - ID: ' + currentBookmarkId);
            } else {
                modalTitle.textContent = 'æ·»åŠ æ”¶è—';
                bookmarkName.value = '';
                bookmarkUrl.value = '';
                bookmarkIcon.value = '';
                updateIconPreview();
                debug('æ˜¾ç¤ºæ·»åŠ æ”¶è—é¡¹æ¨¡æ€æ¡†');
            }
            
            bookmarkModal.style.display = 'flex';
        }

        // ä¿å­˜æ”¶è—é¡¹
        async function saveBookmark() {
            const name = bookmarkName.value.trim();
            const url = bookmarkUrl.value.trim();
            const icon = bookmarkIcon.value.trim();
            
            if (!url) {
                alert('è¯·å¡«å†™ç½‘å€');
                debug('ä¿å­˜å¤±è´¥: ç½‘å€ä¸ºç©º');
                return;
            }
            
            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            let formattedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                formattedUrl = 'https://' + url;
            }
            
            let finalIcon = icon;
            
            // å¦‚æœæ²¡æœ‰æä¾›å›¾æ ‡ï¼Œå°è¯•è‡ªåŠ¨è·å–ç½‘ç«™å›¾æ ‡
            if (!finalIcon) {
                debug('æœªæä¾›å›¾æ ‡ï¼Œå°è¯•è‡ªåŠ¨è·å–ç½‘ç«™å›¾æ ‡');
                finalIcon = await getFavicon(formattedUrl);
            }
            
            if (isEditing && currentBookmarkId) {
                // æ›´æ–°ç°æœ‰æ”¶è—é¡¹
                const index = bookmarks.findIndex(b => b.id === currentBookmarkId);
                if (index !== -1) {
                    bookmarks[index].name = name;
                    bookmarks[index].url = formattedUrl;
                    bookmarks[index].icon = finalIcon;
                    debug('æ›´æ–°æ”¶è—é¡¹ - ID: ' + currentBookmarkId);
                }
            } else {
                // æ·»åŠ æ–°æ”¶è—é¡¹
                const newId = bookmarks.length > 0 ? Math.max(...bookmarks.map(b => b.id)) + 1 : 1;
                bookmarks.push({
                    id: newId,
                    name,
                    url: formattedUrl,
                    icon: finalIcon
                });
                debug('æ·»åŠ æ–°æ”¶è—é¡¹ - ID: ' + newId);
            }
            
            saveBookmarks();
            renderBookmarks();
            bookmarkModal.style.display = 'none';
        }

        // è·å–ç½‘ç«™å›¾æ ‡
        async function getFavicon(url) {
            try {
                // ä½¿ç”¨Googleçš„faviconæœåŠ¡
                const domain = new URL(url).hostname;
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                
                // æµ‹è¯•å›¾æ ‡æ˜¯å¦å¯åŠ è½½
                return await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        debug('æˆåŠŸè·å–ç½‘ç«™å›¾æ ‡: ' + faviconUrl);
                        resolve(faviconUrl);
                    };
                    img.onerror = () => {
                        debug('æ— æ³•è·å–ç½‘ç«™å›¾æ ‡ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
                        resolve('âŒ');
                    };
                    img.src = faviconUrl;
                });
            } catch (error) {
                debug('è·å–ç½‘ç«™å›¾æ ‡æ—¶å‡ºé”™: ' + error);
                return 'âŒ';
            }
        }

        // åˆ é™¤æ”¶è—é¡¹
        function deleteBookmark() {
            if (currentBookmarkId && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—é¡¹å—ï¼Ÿ')) {
                bookmarks = bookmarks.filter(b => b.id !== currentBookmarkId);
                saveBookmarks();
                renderBookmarks();
                debug('åˆ é™¤æ”¶è—é¡¹ - ID: ' + currentBookmarkId);
            }
        }

        // è§£æä¹¦ç­¾HTMLæ–‡ä»¶
        function parseBookmarksHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // æŸ¥æ‰¾ä¹¦ç­¾é“¾æ¥
            const links = doc.querySelectorAll('a');
            bookmarks = []; // æ¸…ç©ºç°æœ‰ä¹¦ç­¾
            
            links.forEach(link => {
                const href = link.getAttribute('href');
                const text = link.textContent;
                
                if (href && href.startsWith('http')) {
                    const newId = bookmarks.length > 0 ? Math.max(...bookmarks.map(b => b.id)) + 1 : 1;
                    bookmarks.push({
                        id: newId,
                        name: text.length > 20 ? text.substring(0, 20) : text,
                        url: href,
                        icon: 'ğŸ”—'
                    });
                }
            });
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¹¦ç­¾ï¼Œæ¢å¤é»˜è®¤
            if (bookmarks.length === 0) {
                bookmarks = [...defaultBookmarks];
                alert('æœªæ‰¾åˆ°æ›¸ç°½æˆ–æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºï¼Œå·²æ¢å¾©é»˜èªæ›¸ç±¤');
                debug('å¯¼å…¥å¤±è´¥: æœªæ‰¾åˆ°æœ‰æ•ˆä¹¦ç­¾ï¼Œæ¢å¤é»˜è®¤');
            } else {
                debug('æˆåŠŸå¯¼å…¥ä¹¦ç­¾: ' + bookmarks.length + ' é¡¹');
            }
            
            saveBookmarks();
            renderBookmarks();
        }
    </script>
</body>
</html>