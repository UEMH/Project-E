<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦ç­¾ç®¡ç† - Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            <% if (settings && settings.wallpaper) { %>
                background: url('<%= settings.wallpaper %>') no-repeat center center fixed;
            <% } else { %>
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            <% } %>
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        .content-overlay {
            background: rgba(0, 0, 0, 0.7);
            min-height: 100vh;
            padding: 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-folder-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .toggle-folder-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .login-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-block;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .login-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-welcome {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .page-title {
            color: #fff;
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        /* å£çº¸ä¸Šä¼ åŒºåŸŸ */
        .wallpaper-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            color: #fff;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
        }

        .upload-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .file-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            flex: 1;
            min-width: 200px;
        }

        .upload-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .upload-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        /* ä¹¦ç­¾åŒºåŸŸ */
        .bookmarks-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bookmarks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bookmark-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bookmark-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .bookmark-link {
            color: #fff;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
        }

        .bookmark-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .bookmark-url {
            font-size: 12px;
            color: #ccc;
            word-break: break-all;
            opacity: 0.8;
        }

        .bookmark-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* è¡¨å•æ ·å¼ */
        .add-bookmark-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            color: #fff;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            height: fit-content;
        }

        .add-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-edit:hover {
            background: #1976D2;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .btn-debug {
            background: #9C27B0;
            color: white;
        }

        .btn-debug:hover {
            background: #7B1FA2;
        }

        /* è°ƒè¯•ä¿¡æ¯ */
        .debug-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .debug-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .debug-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-left, .nav-right {
                justify-content: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .upload-form {
                flex-direction: column;
                align-items: stretch;
            }

            .file-input {
                min-width: auto;
            }

            .bookmarks-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æ¬¢è¿é¡µé¢æ ·å¼ */
        .welcome-container {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-title {
            color: #fff;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .welcome-message {
            color: #ccc;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .message-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .message-error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        /* æ— å†…å®¹çŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #ccc;
            grid-column: 1 / -1;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="content-overlay">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="top-nav">
            <div class="nav-left">
                <button class="toggle-folder-btn" id="toggleFolder">
                    <span id="folderIcon">ğŸ“</span>
                    <span id="folderText">æ”¶èµ·æ”¶è—å¤¹</span>
                </button>
                <h1 class="page-title">æˆ‘çš„ä¹¦ç­¾</h1>
            </div>
            <div class="nav-right">
                <% if (user) { %>
                    <div class="user-info">
                        <span class="user-welcome">æ¬¢è¿, <%= user.username %></span>
                        <form action="/logout" method="POST" style="display: inline;">
                            <button type="submit" class="logout-btn">ç™»å‡º</button>
                        </form>
                    </div>
                <% } else { %>
                    <a href="/login" class="login-btn">ç™»å½•</a>
                <% } %>
            </div>
        </div>

        <% if (user) { %>
            <!-- å£çº¸ä¸Šä¼ åŒºåŸŸ -->
            <div class="wallpaper-section">
                <h3 class="section-title">ä¸ªæ€§åŒ–è®¾ç½®</h3>
                <form class="upload-form" id="wallpaperForm" enctype="multipart/form-data">
                    <input type="file" name="wallpaper" accept="image/*" required class="file-input">
                    <button type="submit" class="upload-btn">ä¸Šä¼ å£çº¸</button>
                </form>
                <div id="uploadResult"></div>
                
                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div class="debug-info">
                    <h4 style="color: #fff; margin-bottom: 10px;">è°ƒè¯•ä¿¡æ¯</h4>
                    <p>ç”¨æˆ·ID: <code><%= user.id %></code></p>
                    <p>å½“å‰å£çº¸: <span id="currentWallpaper">
                        <% if (settings && settings.wallpaper) { %>
                            <code><%= settings.wallpaper %></code>
                        <% } else { %>
                            <em>é»˜è®¤å£çº¸</em>
                        <% } %>
                    </span></p>
                    <div class="debug-actions">
                        <button class="btn btn-debug" onclick="checkSettings()">æ£€æŸ¥è®¾ç½®</button>
                        <button class="btn btn-debug" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
                        <button class="btn btn-debug" onclick="testSync()">æµ‹è¯•åŒæ­¥</button>
                    </div>
                    <div id="settingsInfo" class="debug-result"></div>
                </div>
            </div>

            <!-- æ·»åŠ ä¹¦ç­¾è¡¨å• -->
            <div class="add-bookmark-form">
                <h3 class="section-title">æ·»åŠ æ–°ä¹¦ç­¾</h3>
                <form id="addBookmarkForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ä¹¦ç­¾åç§°</label>
                            <input type="text" name="name" required class="form-input" placeholder="è¾“å…¥ä¹¦ç­¾åç§°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç½‘å€</label>
                            <input type="url" name="url" required class="form-input" placeholder="https://example.com">
                        </div>
                        <button type="submit" class="add-btn">æ·»åŠ ä¹¦ç­¾</button>
                    </div>
                </form>
            </div>

            <!-- ä¹¦ç­¾åˆ—è¡¨åŒºåŸŸ -->
            <div class="bookmarks-section" id="bookmarksSection">
                <h3 class="section-title">æˆ‘çš„æ”¶è—å¤¹</h3>
                
                <!-- ä¹¦ç­¾åˆ—è¡¨ -->
                <div class="bookmarks-grid" id="bookmarksContainer">
                    <% if (bookmarks && bookmarks.length > 0) { %>
                        <% bookmarks.forEach(function(bookmark) { %>
                            <div class="bookmark-item" data-id="<%= bookmark._id %>">
                                <a href="<%= bookmark.url %>" target="_blank" class="bookmark-link">
                                    <div class="bookmark-name"><%= bookmark.name %></div>
                                    <div class="bookmark-url"><%= bookmark.url %></div>
                                </a>
                                <div class="bookmark-actions">
                                    <button class="btn btn-edit" onclick="editBookmark('<%= bookmark._id %>', '<%= bookmark.name %>', '<%= bookmark.url %>')">ç¼–è¾‘</button>
                                    <button class="btn btn-delete" onclick="deleteBookmark('<%= bookmark._id %>')">åˆ é™¤</button>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‘</div>
                            <p>æš‚æ— ä¹¦ç­¾ï¼Œè¯·æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä¹¦ç­¾</p>
                        </div>
                    <% } %>
                </div>
            </div>

        <% } else { %>
            <!-- æœªç™»å½•çŠ¶æ€æ˜¾ç¤ºæ¬¢è¿é¡µé¢ -->
            <div class="welcome-container">
                <h1 class="welcome-title">æ¬¢è¿ä½¿ç”¨ä¹¦ç­¾ç®¡ç†ç³»ç»Ÿ</h1>
                <p class="welcome-message">
                    è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ä¸ªäººä¹¦ç­¾ç®¡ç†å·¥å…·ï¼Œ<br>
                    å¸®åŠ©æ‚¨éšæ—¶éšåœ°è®¿é—®å’Œç®¡ç†æ‚¨å–œçˆ±çš„ç½‘ç«™ã€‚
                </p>
                <a href="/login" class="login-btn" style="padding: 12px 30px; font-size: 16px;">ç«‹å³ç™»å½•</a>
                <div style="margin-top: 20px;">
                    <a href="/register" style="color: #2196F3; text-decoration: none;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</a>
                </div>
            </div>
        <% } %>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', '<%= user ? user.username : "æœªç™»å½•" %>');
            console.log('ğŸ¨ å£çº¸è®¾ç½®:', '<%= settings ? settings.wallpaper : "æ— " %>');
            console.log('ğŸ“š ä¹¦ç­¾æ•°é‡:', '<%= bookmarks ? bookmarks.length : 0 %>');
            
            // åˆå§‹åŒ–æ”¶è—å¤¹çŠ¶æ€
            const isCollapsed = localStorage.getItem('bookmarksCollapsed') === 'true';
            if (isCollapsed) {
                collapseBookmarks();
            }
        });

        // å£çº¸ä¸Šä¼ åŠŸèƒ½
        const wallpaperForm = document.getElementById('wallpaperForm');
        if (wallpaperForm) {
            wallpaperForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const resultDiv = document.getElementById('uploadResult');
                const submitBtn = this.querySelector('button[type="submit"]');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.textContent = 'ä¸Šä¼ ä¸­...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/upload-wallpaper', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        resultDiv.innerHTML = `<div class="message message-success">âœ… ${data.message}</div>`;
                        resultDiv.innerHTML += `<p style="margin-top: 10px;">å£çº¸URL: <code>${data.wallpaperUrl}</code></p>`;
                        
                        // ç«‹å³æ›´æ–°é¡µé¢èƒŒæ™¯
                        document.body.style.backgroundImage = `url('${data.wallpaperUrl}')`;
                        document.getElementById('currentWallpaper').innerHTML = `<code>${data.wallpaperUrl}</code>`;
                        
                        // 3ç§’ååˆ·æ–°é¡µé¢
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else {
                        resultDiv.innerHTML = `<div class="message message-error">âŒ ${data.error}</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="message message-error">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.textContent = 'ä¸Šä¼ å£çº¸';
                    submitBtn.disabled = false;
                }
            });
        }

        // æ·»åŠ ä¹¦ç­¾åŠŸèƒ½
        const addBookmarkForm = document.getElementById('addBookmarkForm');
        if (addBookmarkForm) {
            addBookmarkForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                const submitBtn = this.querySelector('button[type="submit"]');
                
                // éªŒè¯URLæ ¼å¼
                if (!data.url.startsWith('http://') && !data.url.startsWith('https://')) {
                    alert('ç½‘å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.textContent = 'æ·»åŠ ä¸­...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/bookmarks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('âœ… ä¹¦ç­¾æ·»åŠ æˆåŠŸï¼');
                        window.location.reload();
                    } else {
                        alert('âŒ æ·»åŠ å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    alert('âŒ æ·»åŠ å¤±è´¥: ' + error.message);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.textContent = 'æ·»åŠ ä¹¦ç­¾';
                    submitBtn.disabled = false;
                }
            });
        }

        // åˆ é™¤ä¹¦ç­¾åŠŸèƒ½
        async function deleteBookmark(bookmarkId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            
            try {
                const response = await fetch(`/bookmarks/${bookmarkId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ä¹¦ç­¾åˆ é™¤æˆåŠŸï¼');
                    window.location.reload();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘ä¹¦ç­¾åŠŸèƒ½
        async function editBookmark(bookmarkId, currentName, currentUrl) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ä¹¦ç­¾åç§°:', currentName);
            if (newName === null) return;
            
            const newUrl = prompt('è¯·è¾“å…¥æ–°çš„ç½‘å€:', currentUrl);
            if (newUrl === null) return;
            
            // éªŒè¯URLæ ¼å¼
            if (newUrl && !newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
                alert('ç½‘å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
                return;
            }
            
            try {
                const response = await fetch(`/bookmarks/${bookmarkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: newName,
                        url: newUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ä¹¦ç­¾æ›´æ–°æˆåŠŸï¼');
                    window.location.reload();
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // æ”¶èµ·/å±•å¼€æ”¶è—å¤¹åŠŸèƒ½
        const toggleFolderBtn = document.getElementById('toggleFolder');
        if (toggleFolderBtn) {
            toggleFolderBtn.addEventListener('click', function() {
                const bookmarksSection = document.getElementById('bookmarksSection');
                const folderIcon = document.getElementById('folderIcon');
                const folderText = document.getElementById('folderText');
                
                if (bookmarksSection.style.display === 'none') {
                    // å±•å¼€
                    bookmarksSection.style.display = 'block';
                    folderIcon.textContent = 'ğŸ“';
                    folderText.textContent = 'æ”¶èµ·æ”¶è—å¤¹';
                    localStorage.setItem('bookmarksCollapsed', 'false');
                } else {
                    // æ”¶èµ·
                    bookmarksSection.style.display = 'none';
                    folderIcon.textContent = 'ğŸ“‚';
                    folderText.textContent = 'å±•å¼€æ”¶è—å¤¹';
                    localStorage.setItem('bookmarksCollapsed', 'true');
                }
            });
        }

        // æ”¶èµ·æ”¶è—å¤¹çš„å‡½æ•°
        function collapseBookmarks() {
            const bookmarksSection = document.getElementById('bookmarksSection');
            const folderIcon = document.getElementById('folderIcon');
            const folderText = document.getElementById('folderText');
            
            if (bookmarksSection) {
                bookmarksSection.style.display = 'none';
                folderIcon.textContent = 'ğŸ“‚';
                folderText.textContent = 'å±•å¼€æ”¶è—å¤¹';
            }
        }

        // æ£€æŸ¥è®¾ç½®åŠŸèƒ½
        async function checkSettings() {
            try {
                const response = await fetch('/debug/my-settings');
                const data = await response.json();
                
                document.getElementById('settingsInfo').innerHTML = `
                    <pre style="color: #fff; margin: 0;">${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('settingsInfo').innerHTML = `
                    <div class="message message-error">æ£€æŸ¥è®¾ç½®å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // æ¸…é™¤ç¼“å­˜åŠŸèƒ½
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å—ï¼Ÿè¿™å°†ä¼šåˆ·æ–°é¡µé¢ã€‚')) {
                localStorage.clear();
                sessionStorage.clear();
                // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œå¿½ç•¥ç¼“å­˜
                window.location.reload(true);
            }
        }

        // æµ‹è¯•åŒæ­¥åŠŸèƒ½
        async function testSync() {
            try {
                const response = await fetch('/api/bookmarks');
                const data = await response.json();
                
                document.getElementById('settingsInfo').innerHTML = `
                    <div class="message message-success">
                        âœ… åŒæ­¥æµ‹è¯•æˆåŠŸï¼<br>
                        å½“å‰ç”¨æˆ·æœ‰ ${data.bookmarks.length} ä¸ªä¹¦ç­¾
                    </div>
                    <pre style="color: #fff; margin: 10px 0 0 0; font-size: 10px;">
æœ€åæ›´æ–°: ${new Date().toLocaleString()}
ç”¨æˆ·ID: <%= user.id %>
ä¹¦ç­¾æ•°é‡: ${data.bookmarks.length}
                    </pre>
                `;
            } catch (error) {
                document.getElementById('settingsInfo').innerHTML = `
                    <div class="message message-error">åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl + D åˆ‡æ¢æ”¶è—å¤¹æ˜¾ç¤º
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                document.getElementById('toggleFolder')?.click();
            }
            
            // Esc é”®æ¸…é™¤è°ƒè¯•ä¿¡æ¯
            if (e.key === 'Escape') {
                document.getElementById('settingsInfo').innerHTML = '';
            }
        });
    </script>
</body>
</html>
